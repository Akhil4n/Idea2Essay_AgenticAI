<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Video Generator</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 20px; max-width: 1200px; }
    textarea { width: 100%; height: 80px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; }
    button { margin-top: 10px; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
    button:hover { background: #2563eb; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    .agent-box { border: 1px solid #d1d5db; padding: 16px; margin-top: 16px; border-radius: 8px; background: #f9fafb; }
    .agent-title { font-weight: 700; margin-bottom: 8px; color: #1f2937; font-size: 16px; }
    #status { margin-top: 12px; padding: 12px; border-radius: 6px; font-weight: 500; }
    .status-running { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
    .status-complete { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
    .status-video { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }
    pre { white-space: pre-wrap; margin: 0; font-family: 'Monaco', monospace; font-size: 14px; line-height: 1.5; }
    .video-container { margin-top: 16px; text-align: center; }
    video { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .filename { font-size: 12px; color: #6b7280; margin-top: 8px; }
    .spinner {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 8px auto;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner-text {
      font-size: 13px;
      color: #4b5563;
      text-align: center;
      margin-top: 4px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>AI Video Generator</h1>
  <p>Enter a topic and watch 4 AI agents collaborate to generate a 10-second AI video.</p>
  <label for="prompt"><strong>Video topic:</strong></label>
  <textarea id="prompt" placeholder="e.g., Greek Mythology"></textarea>
  <br />
  <button id="run-btn">Generate 10s AI Video</button>
  <div id="status" class="status-running" style="display:none;"></div>
  <div class="agent-box">
    <div class="agent-title">Agent A - Video Outline</div>
    <pre id="agent-a-output">Waiting for workflow...</pre>
  </div>
  <div class="agent-box">
    <div class="agent-title">Agent B - Scene Plan + Visuals</div>
    <pre id="agent-b-output"></pre>
  </div>
  <div class="agent-box">
    <div class="agent-title">Agent C - Final Video Prompt</div>
    <div id="agent-c-output" style="white-space: pre-wrap; font-family: monospace; font-size: 14px;"></div>
  </div>
  <div class="agent-box">
    <div class="agent-title">Agent D - AI Video</div>
    <div id="agent-d-output" style="white-space: pre-wrap; font-family: monospace; font-size: 14px;"></div>
    <div class="filename" id="filename-display"></div>
    <div id="spinner-container">
      <div id="video-spinner" class="spinner"></div>
      <div id="spinner-text" class="spinner-text">Generating video...</div>
    </div>
    <div class="video-container" id="video-container" style="display:none;">
      <video id="result-video" controls preload="metadata"></video>
    </div>
  </div>
  <script>
    const runBtn = document.getElementById('run-btn');
    const statusDiv = document.getElementById('status');
    const videoContainer = document.getElementById('video-container');
    const videoEl = document.getElementById('result-video');
    const filenameDisplay = document.getElementById('filename-display');
    const spinner = document.getElementById('video-spinner');
    const spinnerText = document.getElementById('spinner-text');

    function nl2br(str) {
      if (!str) return '';
      return str.replace(/\n/g, '<br>');
    }

    function updateStatus(message, type = 'running') {
      statusDiv.textContent = message;
      statusDiv.className = `status-${type}`;
      statusDiv.style.display = 'block';
    }

    function showSpinner() {
      spinner.style.display = 'block';
      spinnerText.style.display = 'block';
    }

    function hideSpinner() {
      spinner.style.display = 'none';
      spinnerText.style.display = 'none';
    }

    runBtn.addEventListener('click', async () => {
      const prompt = document.getElementById('prompt').value.trim();
      if (!prompt) {
        updateStatus('Please enter a topic first.', 'running');
        return;
      }

      runBtn.disabled = true;
      runBtn.textContent = 'Generating...';
      updateStatus('Starting 4-agent workflow...', 'running');
      
      document.getElementById('agent-a-output').textContent = 'Waiting for workflow...';
      document.getElementById('agent-b-output').textContent = '';
      document.getElementById('agent-c-output').innerHTML = '';
      document.getElementById('agent-d-output').innerHTML = '';
      filenameDisplay.textContent = '';
      videoContainer.style.display = 'none';
      videoEl.src = '';
      hideSpinner();

      try {
        const response = await fetch('/run_workflow_stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const parts = buffer.split('\n\n');
          buffer = parts.pop() || '';

          for (const part of parts) {
            const line = part.trim();
            if (!line.startsWith('data:')) continue;

            const jsonStr = line.substring(5).trim();
            let event;
            try {
              event = JSON.parse(jsonStr);
            } catch (e) {
              continue;
            }

            const agent = event.agent;
            const content = event.content || '';
            const videoUrl = event.video_url || null;
            const videoStatus = event.video_status || '';
            const filename = event.filename || '';

            if (agent === 'A') {
              document.getElementById('agent-a-output').textContent = content;
              updateStatus('Agent A complete. Agent B creating scenes + visuals...', 'running');
            } else if (agent === 'B') {
              document.getElementById('agent-b-output').textContent = content;
              updateStatus('Agent B complete. Agent C building final prompt...', 'running');
            } else if (agent === 'C') {
              document.getElementById('agent-c-output').innerHTML = nl2br(content);
              updateStatus('Agent C complete. Agent D generating video...', 'running');
              showSpinner();
            } else if (agent === 'D') {
              hideSpinner();
              if (filename && filename !== 'N/A') {
                filenameDisplay.textContent = `Saved as: ${filename}`;
              }
              updateStatus(`Agent D complete. Video status: ${videoStatus}`, 'video');
              
              if (videoUrl) {
                videoEl.src = videoUrl;
                videoContainer.style.display = 'block';
                videoEl.load();
              }
            } else if (agent === 'DONE') {
              updateStatus('Complete! 4 agents generated your 10s video.', 'complete');
            } else if (agent === 'ERROR') {
              updateStatus(`Error: ${content}`, 'running');
            }
          }
        }
      } catch (err) {
        console.error(err);
        updateStatus(`Error: ${err.message}`, 'running');
      } finally {
        runBtn.disabled = false;
        runBtn.textContent = 'Generate 10s AI Video';
      }
    });
  </script>
</body>
</html>
